<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dwarf War — App</title>
    <style>
      html, body { height: 100%; margin: 0; background: #0b0f12; }
      #renderCanvas { width: 100vw; height: 100vh; display: block; touch-action: none; }
      .overlay { position: absolute; top: 8px; left: 10px; color: #cfd8dc; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 12px; }
      .panel { position: absolute; top: 8px; right: 10px; bottom: 8px; width: 360px; max-width: calc(100vw - 40px); background: rgba(10,14,18,0.9); border: 1px solid #1e2a30; border-radius: 8px; padding: 10px; color: #e3edf3; display: flex; flex-direction: column; overflow: hidden; }
      .panel h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 600; }
      .panel .header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
      .panel .panel-content { flex: 1; min-height: 0; overflow: auto; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
      .row label { display: inline-flex; align-items: center; gap: 6px; }
      .btn { background: #1f2b33; color: #e3edf3; border: 1px solid #2b3a42; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px; }
      .btn:hover { background: #27353e; }
      .btn.warn { background: #3a2624; border-color: #5a2e2b; }
      .icon-btn { background: transparent; color: #9fb2bb; border: 1px solid #2b3a42; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 13px; }
      .icon-btn:hover { background: #162028; }
      textarea { width: 100%; min-height: 120px; background: #0f151a; color: #cfe1ea; border: 1px solid #1e2a30; border-radius: 6px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
      .hint { color: #a7bac3; font-size: 11px; margin-top: 6px; }
      .collapse { background: transparent; color: #9fb2bb; border: 1px solid #2b3a42; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px; }
      .panel.collapsed { display: flex; align-items: flex-start; }
      .panel.collapsed .panel-content, .panel.collapsed h3, .panel.collapsed .row, .panel.collapsed .hint, .panel.collapsed #assistantOutput { display: none; }
      .panel.collapsed .header-title { display: none; }

      /* Settings modal */
      .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 1000; }
      .modal.open { display: flex; }
      .modal-card { width: min(640px, 96vw); max-height: 90vh; overflow: auto; background: #0f151a; border: 1px solid #1e2a30; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); padding: 14px; color: #e3edf3; }
      .modal-card h3 { margin: 0 0 10px 0; }
      .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
      .field input, .field select { width: 100%; background: #0f151a; color: #cfe1ea; border: 1px solid #1e2a30; border-radius: 6px; padding: 6px 8px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

      /* Tabs */
      .tabs { display: flex; gap: 6px; border-bottom: 1px solid #1e2a30; margin-bottom: 8px; }
      .tab { background: transparent; color: #9fb2bb; border: 1px solid #2b3a42; border-bottom: none; border-radius: 6px 6px 0 0; padding: 6px 10px; cursor: pointer; font-size: 12px; }
      .tab.active { background: #162028; color: #e3edf3; border-color: #2b3a42; }
      .tab-pane { display: none; }
      .tab-pane.active { display: block; }
      /* DB view */
      .db-view details { border: 1px solid #1e2a30; border-radius: 6px; padding: 6px 8px; margin: 6px 0; background: #0f151a; }
      .db-view summary { cursor: pointer; color: #cfe1ea; }
      .db-view .kv { color: #9fb2bb; font-size: 12px; }
      /* DB row highlight */
      .db-view details { transition: background 0.6s ease, box-shadow 0.6s ease; }
      .db-view details.flash-highlight { background: #132430 !important; box-shadow: 0 0 0 2px rgba(90,169,230,0.45) inset; }
    </style>
    <script>
      // Early dev prelude: enable error forwarding by default on localhost and attach early listeners
      (function(){
        try {
          var hn = location.hostname || '';
          var isLocal = hn === 'localhost' || hn === '127.0.0.1' || hn.endsWith('.local') || hn === '';
          if (isLocal) {
            if (localStorage.getItem('dw:dev:sendErrors') !== '1') {
              localStorage.setItem('dw:dev:sendErrors', '1');
            }
            if (localStorage.getItem('dw:dev:sendLogs') !== '1') {
              localStorage.setItem('dw:dev:sendLogs', '1');
            }
          }
        } catch {}
        // Start a new session ASAP and clear server log before anything else
        try {
          var urlClear = 'http://localhost:6060/log?session=start';
          fetch(urlClear, { method: 'GET', keepalive: true, mode: 'no-cors' }).catch(function(){});
        } catch {}
        function send(obj){
          try {
            if (localStorage.getItem('dw:dev:sendErrors') !== '1') return;
            var url = 'http://localhost:6060/log';
            var data = Object.assign({}, obj || {});
            if (navigator.sendBeacon) {
              // Use text/plain for broad sendBeacon compatibility
              var blob = new Blob([JSON.stringify(data)], { type: 'text/plain;charset=UTF-8' });
              navigator.sendBeacon(url, blob);
            } else {
              fetch(url, { method: 'POST', body: JSON.stringify(data), keepalive: true, mode: 'no-cors' }).catch(function(){});
            }
          } catch {}
        }
        // Also record a session start line (after clear)
        try { send({ type: 'session', event: 'start' }); } catch {}
        try { window.addEventListener('error', function(e){
          try {
            send({ type: 'early:error', message: e.message, file: e.filename, line: e.lineno, col: e.colno, stack: (e.error && e.error.stack) ? String(e.error.stack) : undefined });
          } catch {}
        }, { capture: true }); } catch {}
        try { window.addEventListener('unhandledrejection', function(e){
          try {
            send({ type: 'early:unhandledrejection', reason: String(e.reason), stack: (e.reason && e.reason.stack) ? String(e.reason.stack) : undefined });
          } catch {}
        }); } catch {}

        // Also forward console errors/warnings during dev to avoid misses when errors are caught and logged
        try {
          var _origErr = console.error.bind(console);
          var _origWarn = console.warn.bind(console);
          var _origLog = console.log.bind(console);
          var _origInfo = console.info.bind(console);
          var _origDebug = console.debug ? console.debug.bind(console) : function(){};
          function fmtArg(a){
            if (typeof a === 'string') return a;
            try { return JSON.stringify(a); } catch { try { return String(a); } catch { return '[unprintable]'; } }
          }
          console.error = function(){
            try { send({ type: 'console:error', args: Array.from(arguments).map(fmtArg) }); } catch {}
            return _origErr.apply(console, arguments);
          };
          console.warn = function(){
            try { send({ type: 'console:warn', args: Array.from(arguments).map(fmtArg) }); } catch {}
            return _origWarn.apply(console, arguments);
          };
          function selectedAllowsClass(cls){
            try {
              var raw = localStorage.getItem('dw:log:selected');
              if (!raw) return true; // no selection stored -> allow
              var arr = JSON.parse(raw);
              if (Array.isArray(arr)) return !cls || arr.indexOf(String(cls)) !== -1;
              return true;
            } catch { return true; }
          }
          function maybeForward(kind){
            try { return (localStorage.getItem('dw:dev:sendLogs') === '1'); } catch { return false; }
          }
          function extractClassFromArgs(args){
            if (!args || !args.length) return null;
            var first = String(args[0] || '');
            var m = first.match(/^\[([^\]]+)\]$/);
            return m ? m[1] : null;
          }
          console.log = function(){
            try {
              if (maybeForward('log')) {
                var cls = extractClassFromArgs(arguments);
                if (selectedAllowsClass(cls)) send({ type: 'console:log', args: Array.from(arguments).map(fmtArg) });
              }
            } catch {}
            return _origLog.apply(console, arguments);
          };
          console.info = function(){
            try {
              if (maybeForward('info')) {
                var cls = extractClassFromArgs(arguments);
                if (selectedAllowsClass(cls)) send({ type: 'console:info', args: Array.from(arguments).map(fmtArg) });
              }
            } catch {}
            return _origInfo.apply(console, arguments);
          };
          if (console.debug) {
            console.debug = function(){
              try {
                if (maybeForward('debug')) {
                  var cls = extractClassFromArgs(arguments);
                  if (selectedAllowsClass(cls)) send({ type: 'console:debug', args: Array.from(arguments).map(fmtArg) });
                }
              } catch {}
              return _origDebug.apply(console, arguments);
            };
          }
          console.warn = (function(orig){ return function(){ try { if (maybeForward('warn')) { var cls = extractClassFromArgs(arguments); if (selectedAllowsClass(cls)) send({ type: 'console:warn', args: Array.from(arguments).map(fmtArg) }); } } catch {} return orig.apply(console, arguments); }; })(_origWarn);
          console.error = (function(orig){ return function(){ try { if (maybeForward('error')) { var cls = extractClassFromArgs(arguments); if (selectedAllowsClass(cls)) send({ type: 'console:error', args: Array.from(arguments).map(fmtArg) }); } } catch {} return orig.apply(console, arguments); }; })(_origErr);
        } catch {}
      })();
    </script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>
    <div class="overlay" id="hud">Dwarf War • Edit/Game scaffold • drag to orbit</div>
    <div class="panel" id="rightPanel">
      <div class="header">
        <h3 class="header-title">Editor</h3>
        <div style="display:flex; gap:6px; align-items:center;">
          <button class="icon-btn" id="logOpen" title="Log">📜</button>
          <button class="icon-btn" id="settingsOpen" title="Settings">⚙️</button>
          <button class="collapse" id="collapsePanel" title="Collapse/Expand">⟨⟩</button>
        </div>
      </div>
      <div class="panel-content">
        <div class="row">
          <button class="btn" id="reset">Reset</button>
          <button class="btn" id="export">Export</button>
          <input type="file" id="importFile" style="display:none" />
          <button class="btn" id="import">Import</button>
        </div>
        <h3>Spaces</h3>
        <div class="row">
          <label>Type
            <select id="spaceType">
              <option value="Carddon">Carddon</option>
              <option value="Cavern">Cavern</option>
              <option value="Tunnel">Tunnel</option>
              <option value="Room" selected>Room</option>
              <option value="Space">Space</option>
            </select>
          </label>
          <label>Name <input id="spaceName" type="text" placeholder="space-1" style="width:140px;background:#0f151a;color:#cfe1ea;border:1px solid #1e2a30;border-radius:6px;padding:4px 6px;" /></label>
          <button class="btn" id="newSpace">New Space</button>
          <button class="btn" id="fitView">Fit View</button>
        </div>
        <div class="row">
          <label><input type="checkbox" id="showNames" checked /> Names On</label>
        </div>
        <div class="row">
          <label>Size X <input id="sizeX" type="number" value="10" step="1" style="width:72px;background:#0f151a;color:#cfe1ea;border:1px solid #1e2a30;border-radius:6px;padding:4px 6px;" /></label>
          <label>Y <input id="sizeY" type="number" value="10" step="1" style="width:72px;background:#0f151a;color:#cfe1ea;border:1px solid #1e2a30;border-radius:6px;padding:4px 6px;" /></label>
          <label>Z <input id="sizeZ" type="number" value="10" step="1" style="width:72px;background:#0f151a;color:#cfe1ea;border:1px solid #1e2a30;border-radius:6px;padding:4px 6px;" /></label>
          <label><input id="sizeLock" type="checkbox" /> Proportional</label>
          <span class="hint">(voxels)</span>
        </div>
        <h3>View</h3>
        <div class="row">
          <label><input type="checkbox" id="gridGround" checked /> Ground Grid</label>
          <label><input type="checkbox" id="gridXY" checked /> XY Grid</label>
          <label><input type="checkbox" id="gridYZ" checked /> YZ Grid</label>
          <label><input type="checkbox" id="axisArrows" checked /> Axis Arrows</label>
          <label><input type="checkbox" id="viewTargetDot" checked /> View Target</label>
          <button class="btn" id="resizeGrid" title="Resize grids to fit all spaces">Resize Grid</button>
        </div>
        <h3>Transform (Edit Mode)</h3>
        <div class="row">
          <label>Step <input id="tStep" type="number" value="10" min="0.1" step="0.1" style="width:64px;background:#0f151a;color:#cfe1ea;border:1px solid #1e2a30;border-radius:6px;padding:4px 6px;" /> yard</label>
        </div>
        <div class="row">
          <span>X</span>
          <button class="btn" id="txMinus">-</button>
          <button class="btn" id="txPlus">+</button>
          <span>Y</span>
          <button class="btn" id="tyMinus">-</button>
          <button class="btn" id="tyPlus">+</button>
          <span>Z</span>
          <button class="btn" id="tzMinus">-</button>
          <button class="btn" id="tzPlus">+</button>
        </div>
        <div class="hint">Tip: Try describing a central cavern and connections. We’ll map directions to a quick layout and persist to local history.</div>
      </div>
    </div>
    
    <script type="module" src="./main.mjs"></script>
  </body>
  </html>
